<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CryptoID</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0e0f12; color:#fff; }
    .wrap { max-width:720px; margin:0 auto; padding:24px; }
    .card { background:#151820; border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px; }
    .muted { color: rgba(255,255,255,.65); }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
    button, a.btn {
      background:#1f2430; color:#fff; border:1px solid rgba(255,255,255,.10);
      border-radius:12px; padding:12px 14px; cursor:pointer; text-decoration:none;
    }
    button:hover, a.btn:hover { background:#262c3a; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(225,191,65,.12); border:1px solid rgba(225,191,65,.22); color:#E1BF41; font-size:13px; }
    .links a { display:block; padding:10px 12px; border-radius:12px; background:#11141b; border:1px solid rgba(255,255,255,.08); color:#fff; text-decoration:none; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="pill" id="modePill">CryptoID Link</div>
    <h1 style="margin:14px 0 6px;">CryptoID Profile</h1>
    <p class="muted" id="subtitle">Open a profile shared via QR/NFC.</p>

    <div class="card" style="margin-top:16px;">
      <div class="muted" style="font-size:13px;">Profile ID</div>
      <div id="profileId" style="font-size:16px; margin-top:6px; word-break:break-all;"></div>

      <div style="height:12px"></div>

      <div id="status" class="muted">Loading…</div>

      <div class="row">
        <button id="copyBtn">Copy Link</button>
        <button id="shareBtn">Share</button>
        <button id="txtBtn">Download .txt</button>
        <button id="vcfBtn">Save Contact (.vcf)</button>
      </div>
      <div style="height:12px"></div>
      <div class="row" style="margin-top:12px;">
          <a class="btn" id="openInAppBtn" href="#">Open in CryptoID</a>
          <a class="btn" id="installAndroidBtn" href="#" target="_blank" rel="noopener">Install on Android</a>
          <a class="btn" id="installIosBtn" href="#" target="_blank" rel="noopener">Install on iOS</a>
      </div>

      <div class="links" id="links" style="margin-top:14px; display:none;"></div>

      <div style="margin-top:16px;" class="muted">
        Don’t have the app? You can still view public links here.
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAEcMpo48_LUd-a0KPETbSNi1nKEhF2jaQ",
    authDomain: "cryptoid-26e0e.firebaseapp.com",
    projectId: "cryptoid-26e0e",
    storageBucket: "cryptoid-26e0e.firebasestorage.app",
    messagingSenderId: "361788135471",
    appId: "1:361788135471:web:c7ea5f0486138b0064ceda"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== Routing helpers =====

  // New canonical route: /cryptoid/u/<profileId>
  function getProfileIdFromPath() {
    const path = window.location.pathname || ""; // e.g. "/cryptoid/u/test123"
    const parts = path.split("/").filter(Boolean); // ["cryptoid","u","test123"]
    const idx = parts.indexOf("u");
    if (idx !== -1 && parts[idx + 1]) {
      return decodeURIComponent(parts[idx + 1]);
    }
    return null;
  }

  // Backward compatible route: #/p/<profileId>
  function getProfileIdFromHash() {
    const hash = window.location.hash || ""; // e.g. "#/p/test123"
    const parts = hash.replace(/^#\/?/, "").split("/"); // ["p","test123"]
    return parts.length === 2 && parts[0] === "p"
      ? decodeURIComponent(parts[1])
      : null;
  }

  function getProfileId() {
    return getProfileIdFromPath() || getProfileIdFromHash();
  }

  function canonicalUrlForProfile(profileId) {
    // Always share the clean, App-Link-friendly URL
    const origin = window.location.origin; // https://majid460.github.io
    return `${origin}/cryptoid/u/${encodeURIComponent(profileId)}`;
  }

  // ===== DOM =====

  const profileId = getProfileId();
  const profileIdEl = document.getElementById("profileId");
  const statusEl = document.getElementById("status");
  const linksEl = document.getElementById("links");
  const subtitleEl = document.getElementById("subtitle");

  // For share/copy/download, always prefer canonical link
  const currentUrl = profileId ? canonicalUrlForProfile(profileId) : window.location.href;

  profileIdEl.textContent = profileId ?? "(invalid)";
  subtitleEl.textContent = profileId
    ? "Tap/scan link to view the latest profile."
    : "Invalid CryptoID link.";

  // ===== Buttons =====

  document.getElementById("copyBtn").onclick = async () => {
    await navigator.clipboard.writeText(currentUrl);
    statusEl.textContent = "Copied link ✅";
  };

  document.getElementById("shareBtn").onclick = async () => {
    if (navigator.share) {
      await navigator.share({
        title: "CryptoID Profile",
        url: currentUrl
      });
    } else {
      // fallback
      await navigator.clipboard.writeText(currentUrl);
      statusEl.textContent = "Share not supported. Copied link ✅";
    }
  };

  document.getElementById("txtBtn").onclick = () => {
    const blob = new Blob([currentUrl], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "cryptoid-link.txt";
    a.click();
  };

  document.getElementById("vcfBtn").onclick = () => {
    const vcf =
`BEGIN:VCARD
VERSION:3.0
FN:CryptoID Profile
URL:${currentUrl}
END:VCARD`;
    const blob = new Blob([vcf], { type: "text/vcard" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "cryptoid.vcf";
    a.click();
  };

  // ===== Profile loading =====

  async function loadProfile(profileId) {
    statusEl.textContent = "Loading profile…";
    linksEl.innerHTML = "";
    linksEl.style.display = "none";

    try {
      const snap = await getDoc(doc(db, "profiles", profileId));

      if (!snap.exists()) {
        statusEl.textContent = "Profile not found. Ask the sender to re-share.";
        return;
      }

      const data = snap.data();
      document.querySelector("h1").textContent =
        data.displayName || "CryptoID Profile";

      const links = Array.isArray(data.links) ? data.links : [];
      const renderedLinks = [];

      links.forEach(item => {
        if (item && typeof item === "object") {
          Object.entries(item).forEach(([label, url]) => {
            if (typeof url === "string" && url.startsWith("http")) {
              renderedLinks.push({ label, url });
            }
          });
        }
      });

      if (renderedLinks.length === 0) {
        statusEl.textContent = "No public links shared yet.";
        return;
      }

      statusEl.textContent = "Links";
      linksEl.style.display = "block";
      linksEl.innerHTML = renderedLinks
        .map(
          l =>
            `<a href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`
        )
        .join("");

    } catch (e) {
      console.error(e);
      statusEl.textContent = "Error loading profile.";
    }
  }

  if (profileId) loadProfile(profileId);

  // ===== Install/Open in app section =====
  // TODO: replace with real links later
  const ANDROID_INSTALL_URL = "https://example.com/android.apk";
  const IOS_INSTALL_URL = "https://example.com/testflight";

  // Deep link (only for the button — NOT for sharing)
  // Keep consistent with your app handler.
  const deepLink = profileId
    ? `cryptoid://profile/${encodeURIComponent(profileId)}`
    : `cryptoid://home`;

  const openBtn = document.getElementById("openInAppBtn");
  const aBtn = document.getElementById("installAndroidBtn");
  const iBtn = document.getElementById("installIosBtn");

  if (aBtn) aBtn.href = ANDROID_INSTALL_URL;
  if (iBtn) iBtn.href = IOS_INSTALL_URL;

  if (openBtn) {
    openBtn.onclick = (e) => {
      e.preventDefault();
      if (!profileId) return;

      // Try opening the app
      window.location.href = deepLink;

      // If app didn't open, user stays on web
      setTimeout(() => {
        statusEl.textContent = "If the app didn’t open, install CryptoID below.";
      }, 900);
    };
  }

</script>


</body>
</html>
